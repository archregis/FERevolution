<html>
<div class="sheet-maindiv" style="width: 840px;">
    <div class="sheet-useBackground">
        <div class="sheet-background">
            <div class="sheet-cdiv">
                <!-- Background configuration removed previously -->
            </div>
            <div>
                <button type="action" name="act_character">Character</button>
                <button type="action" name="act_misc">Misc</button>
                <button type="action" name="act_equip">Bonuses</button>
            </div>
            <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="character"/>

            <!-- Character Page -->
            <div class="sheet-character">
                <div id="left-column">
                    <!-- INFO section -->
                    <div class="sheet-charinfo" style="display:inline-block; padding:0; margin:0; color:#000;">
                        <div class="sheet-header" style="margin-bottom:5px; color:#fff;">INFO</div>
                        <table style="border-collapse:collapse; width:auto; color:#000;">
                            <tr style="line-height:1; margin:0; padding:0; color:#000;">
                                <td style="padding:0 5px 0 0;">
                                    <label style="white-space:nowrap; color:#000;">
                                        Name:
                                        <input type="text" name="attr_name" style="width:75px;"/>
                                    </label>
                                </td>
                                <td style="padding:0 5px;">
                                    <label style="white-space:nowrap; color:#000;">
                                        Gender:
                                        <input type="text" name="attr_gender" style="width:55px;"/>
                                    </label>
                                </td>
                                <td style="padding:0 5px;">
                                    <label style="white-space:nowrap; color:#000;">
                                        <select name="attr_all" style="width:80px;">
                                            <option>Player</option>
                                            <option>Ally</option>
                                            <option>Enemy</option>
                                        </select>
                                    </label>
                                </td>
                                <td style="padding:0 5px;">
                                    <label style="white-space:nowrap; color:#000;">
                                        Atk Type:
                                        <select name="attr_atktype" style="width:65px;">
                                            <option>Phys</option>
                                            <option>Mag</option>
                                        </select>
                                    </label>
                                </td>
                            </tr>
                            <tr style="line-height:1; margin:0; padding:0; color:#000;">
                                <td style="padding:0 5px 0 0;">
                                    <label style="white-space:nowrap; color:#000;">
                                        Level:
                                        <input type="number" name="attr_Level" min="1" max="40" value="1" style="width:40px;"/>
                                    </label>
                                </td>
                                <td style="padding:0 5px;">
                                    <label style="white-space:nowrap; color:#000;">
                                        EXP:
                                        <input type="number" name="attr_EXP" min="0" max="999" value="0" style="width:40px;"/>
                                    </label>
                                </td>
                                <td style="padding:0 5px;">
                                    <label style="white-space:nowrap; color:#000;">
                                        Power:
                                        <input type="number" name="attr_Power" min="0" max="999" value="0" style="width:40px;"/>
                                    </label>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Current Values -->
                    <div class="sheet-currentvals">
                        <div class="sheet-row">
                            <table>
                                <tr class="sheet-labelrow">
                                    <th>HP</th>
                                    <th>Phys</th>
                                    <th>Myst</th>
                                    <th>Hit</th>
                                    <th>Crit</th>
                                </tr>
                                <tr>
                                    <td><input name="attr_HP_current" type="number"> / <span name="attr_HP_current_max"></span></td>
                                    <td><span name="attr_phys_total">0</span></td>
                                    <td><span name="attr_myst_total">0</span></td>
                                    <td><span name="attr_Hit">0</span></td>
                                    <td><span name="attr_Crit">0</span></td>
                                </tr>
                                <tr class="sheet-labelrow">
                                    <th>AS</th>
                                    <th>Prot</th>
                                    <th>Ward</th>
                                    <th>Avo</th>
                                    <th>Ddg</th>
                                </tr>
                                <tr>
                                    <td><span name="attr_Atkspd">0</span></td>
                                    <td><span name="attr_prot_total">0</span></td>
                                    <td><span name="attr_ward_total">0</span></td>
                                    <td><span name="attr_Avo">0</span></td>
                                    <td><span name="attr_Ddg">0</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Attributes -->
                    <div class="sheet-mainstats">
                        <div class="sheet-header">ATTRIBUTES</div>
                        <table>
                            <tr class="sheet-labelrow">
                                <th colspan="4">Stats</th>
                                <th class="sheet-div"></th>
                                <th colspan="2">Growths</th>
                            </tr>
                            <tr class="sheet-labelrow">
                                <th class="sheet-statlabel">Stats</th>
                                <th>Personal</th>
                                <th>Buff/Debuff</th>
                                <th>Total</th>
                                <th class="sheet-div"></th>
                                <th>Personal</th>
                                <th>Total</th>
                            </tr>
                            <tr class="HP">
                                <td class="sheet-statlabel">HP</td>
                                <td><input type="number" name="attr_HP_i" value="0"/></td>
                                <td><input type="number" name="attr_HP_bd" value="0"/></td>
                                <td><span name="attr_HP_total">0</span></td>
                                <td class="sheet-div"></td>
                                <!-- HP growth fields -->
                                <input type="number" name="attr_HP_gf" value="0" hidden>
                                <td><input type="number" name="attr_HP_gi" value="0"/></td>
                                <td><span name="attr_HP_gtotal">10</span></td>
                            </tr>
                            <tr class="Str">
                                <td class="sheet-statlabel">Str</td>
                                <td><input type="number" name="attr_Str_i" value="0"/></td>
                                <td><input type="number" name="attr_Str_bd" value="0"/></td>
                                <td><span name="attr_Str_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Str_gi" value="0"/></td>
                                <td><span name="attr_Str_gtotal">0</span></td>
                            </tr>
                            <tr class="Mag">
                                <td class="sheet-statlabel">Mag</td>
                                <td><input type="number" name="attr_Mag_i" value="0"/></td>
                                <td><input type="number" name="attr_Mag_bd" value="0"/></td>
                                <td><span name="attr_Mag_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Mag_gi" value="0"/></td>
                                <td><span name="attr_Mag_gtotal">0</span></td>
                            </tr>
                            <tr class="Skl">
                                <td class="sheet-statlabel">Skl</td>
                                <td><input type="number" name="attr_Skl_i" value="0"/></td>
                                <td><input type="number" name="attr_Skl_bd" value="0"/></td>
                                <td><span name="attr_Skl_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Skl_gi" value="0"/></td>
                                <td><span name="attr_Skl_gtotal">0</span></td>
                            </tr>
                            <tr class="Lck">
                                <td class="sheet-statlabel">Lck</td>
                                <td><input type="number" name="attr_Lck_i" value="0"/></td>
                                <td><input type="number" name="attr_Lck_bd" value="0"/></td>
                                <td><span name="attr_Lck_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Lck_gi" value="0"/></td>
                                <td><span name="attr_Lck_gtotal">0</span></td>
                            </tr>
                            <tr class="Spd">
                                <td class="sheet-statlabel">Spd</td>
                                <td><input type="number" name="attr_Spd_i" value="0"/></td>
                                <td><input type="number" name="attr_Spd_bd" value="0"/></td>
                                <td><span name="attr_Spd_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Spd_gi" value="0"/></td>
                                <td><span name="attr_Spd_gtotal">0</span></td>
                            </tr>
                            <tr class="Def">
                                <td class="sheet-statlabel">Def</td>
                                <td><input type="number" name="attr_Def_i" value="0"/></td>
                                <td><input type="number" name="attr_Def_bd" value="0"/></td>
                                <td><span name="attr_Def_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Def_gi" value="0"/></td>
                                <td><span name="attr_Def_gtotal">0</span></td>
                            </tr>
                            <tr class="Res">
                                <td class="sheet-statlabel">Res</td>
                                <td><input type="number" name="attr_Res_i" value="0"/></td>
                                <td><input type="number" name="attr_Res_bd" value="0"/></td>
                                <td><span name="attr_Res_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Res_gi" value="0"/></td>
                                <td><span name="attr_Res_gtotal">0</span></td>
                            </tr>
                            <tr class="Con">
                                <td class="sheet-statlabel">Con</td>
                                <td><input type="number" name="attr_Con_i" value="0"/></td>
                                <td><input type="number" name="attr_Con_bd" value="0"/></td>
                                <td><span name="attr_Con_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Con_gi" value="0"/></td>
                                <td><span name="attr_Con_gtotal">0</span></td>
                            </tr>
                            <tr class="Mov">
                                <td class="sheet-statlabel">Mov</td>
                                <td><input type="number" name="attr_Mov_i" value="0"/></td>
                                <td><input type="number" name="attr_Mov_bd" value="0"/></td>
                                <td><span name="attr_Mov_total">0</span></td>
                                <td class="sheet-div"></td>
                                <td><input type="number" name="attr_Mov_gi" value="0"/></td>
                                <td><span name="attr_Mov_gtotal">0</span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div id="notes-sheet">
                    <div>
                        <div class="sheet-header" style="color:#fff;">Notes</div>
                        <textarea name="attr_notelist" type="text" style="height:300px; width:215px;"></textarea>
                    </div>

                    <div class="sheet-mainstats">
                        <div class="sheet-header">DERIVED STATS</div>
                        <table>
                            <tr>
                                <th class="sheet-statlabel">Stats</th>
                                <th>Buff/Debuff</th>
                                <th>Total</th>
                            </tr>
                            <tr class="Eva">
                                <td class="sheet-statlabel">Avoid</td>
                                <td><input type="number" name="attr_avo_bd" value="0"/></td>
                                <td><span name="attr_avo">0</span></td>
                            </tr>
                            <tr class="Hit">
                                <td class="sheet-statlabel">Hit</td>
                                <td><input type="number" name="attr_hit_bd" value="0"/></td>
                                <td><span name="attr_hit">0</span></td>
                            </tr>
                            <tr class="Phys">
                                <td class="sheet-statlabel">Phys</td>
                                <td><input type="number" name="attr_phys_bd" value="0"></td>
                                <td><span name="attr_phys_total">0</span></td>
                            </tr>
                            <tr class="Myst">
                                <td class="sheet-statlabel">Myst</td>
                                <td><input type="number" name="attr_myst_bd" value="0"></td>
                                <td><span name="attr_myst_total">0</span></td>
                            </tr>
                            <tr class="Prot">
                                <td class="sheet-statlabel">Prot</td>
                                <td><input type="number" name="attr_prot_bd" value="0"></td>
                                <td><span name="attr_prot_total">0</span></td>
                            </tr>
                            <tr class="Ward">
                                <td class="sheet-statlabel">Ward</td>
                                <td><input type="number" name="attr_ward_bd" value="0"></td>
                                <td><span name="attr_ward_total">0</span></td>
                            </tr>
                            <tr class="Crit">
                                <td class="sheet-statlabel">Crit</td>
                                <td><input type="number" name="attr_Crit_bd" value="0"/></td>
                                <td><span name="attr_Crit">0</span></td>
                            </tr>
                            <tr class="Dodge">
                                <td class="sheet-statlabel">Dodge</td>
                                <td><input type="number" name="attr_Ddg_bd" value="0"/></td>
                                <td><span name="attr_Ddg">0</span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Weapons and Spells side by side -->
                <div style="display:inline-block; width:100%; margin-top:10px;">
                    <div class="sheet-weapons" style="display:inline-block; vertical-align:top; width:49%; margin-right:1%;">
                        <div class="sheet-header">WEAPONS</div>
                        <tr>
                            <th>Weapon Slot</th>
                        </tr>
                        <tr>
                            <td><input type="number" name="attr_WSlot" value="1" min="1"/></td>
                        </tr>
                        <fieldset class="repeating_weapons">
                            <table>
                                <tr>
                                    <th>Weapon Name</th>
                                    <th>Type</th>
                                    <th>Uses</th>
                                </tr>
                                <tr class="sheet-thicc">
                                    <td><input name="attr_WName" type="text"></td>
                                    <td><select name="attr_WType">
                                        <option>Sword</option>
                                        <option>Axe</option>
                                        <option>Lance</option>
                                        <option>Bow</option>
                                    </select></td>
                                    <td><input type="number" name="attr_Uses" value="1" min="0"/></td>
                                </tr>
                            </table>
                            <input type="checkbox" class="sheet-toggle-stats">
                            <span class="sheet-toggle-label">Attributes</span>
                            <table class="sheet-hiddenstats">
                                <tr>
                                    <th>Weight</th>
                                    <th>Might</th>
                                    <th>Hit</th>
                                    <th>Crit</th>
                                    <th>Ddg</th>
                                </tr>
                                <tr>
                                    <td><input type="number" name="attr_Wt" value="0"/></td>
                                    <td><input type="number" name="attr_Mt" value="0"/></td>
                                    <td><input type="number" name="attr_Hit" value="0"/></td>
                                    <td><input type="number" name="attr_Crit" value="0"/></td>
                                    <td><input type="number" name="attr_Ddg" value="0"/></td>
                                </tr>
                                <tr>
                                    <th>HP</th>
                                    <th>Str</th>
                                    <th>Mag</th>
                                    <th>Skl</th>
                                    <th>EXP</th>
                                </tr>
                                <tr>
                                    <td><input name="attr_HP_wp" type="number" value="0"></td>
                                    <td><input name="attr_Str_wp" type="number" value="0"></td>
                                    <td><input name="attr_Mag_wp" type="number" value="0"></td>
                                    <td><input name="attr_Skl_wp" type="number" value="0"></td>
                                    <td><input name="attr_wEXP" type="number" value="0"></td>
                                </tr>
                                <tr>
                                    <th>Spd</th>
                                    <th>Lck</th>
                                    <th>Def</th>
                                    <th>Res</th>
                                    <th>Con</th>
                                </tr>
                                <tr>
                                    <td><input name="attr_Spd_wp" type="number" value="0"></td>
                                    <td><input name="attr_Lck_wp" type="number" value="0"></td>
                                    <td><input name="attr_Def_wp" type="number" value="0"></td>
                                    <td><input name="attr_Res_wp" type="number" value="0"></td>
                                    <td><input name="attr_Con_wp" type="number" value="0"></td>
                                </tr>
                            </table>
                            <div class="sheet-hiddenskill">
                                <label style="font-size: 13px; font-weight: bold"> Weapon Description
                                    <input name="attr_Skill_wp" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> Effective Damage
                                    <input name="attr_Eff_wp" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> 1st Effect
                                    <input name="attr_WepEff1" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> 2nd Effect
                                    <input name="attr_WepEff2" type="text"></input>
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <div class="sheet-spells" style="display:inline-block; vertical-align:top; width:49%;">
                        <div class="sheet-header">SPELLS</div>
                        <tr><th>Spell Slot</th></tr>
                        <tr><td><input type="number" name="attr_SSlot" value="1" min="1"/></td></tr>
                        <fieldset class="repeating_spells">
                            <table>
                                <tr>
                                    <th>Spell Name</th>
                                    <th>Type</th>
                                    <th>Uses</th>
                                </tr>
                                <tr class="sheet-thicc">
                                    <td><input name="attr_SName" type="text"></td>
                                    <td><select name="attr_SType">
                                        <option>Anima</option>
                                        <option>Light</option>
                                        <option>Dark</option>
                                        <option>Staff</option>
                                    </select></td>
                                    <td><input type="number" name="attr_Uses" value="1" min="0"/></td>
                                </tr>
                            </table>
                            <input type="checkbox" class="sheet-toggle-stats">
                            <span class="sheet-toggle-label">Attributes</span>
                            <table class="sheet-hiddenstats">
                                <tr>
                                    <th>Weight</th>
                                    <th>Might</th>
                                    <th>Hit</th>
                                    <th>Crit</th>
                                    <th>Ddg</th>
                                </tr>
                                <tr>
                                    <td><input type="number" name="attr_Wt" value="0"/></td>
                                    <td><input type="number" name="attr_Mt" value="0"/></td>
                                    <td><input type="number" name="attr_Hit" value="0"/></td>
                                    <td><input type="number" name="attr_Crit" value="0"/></td>
                                    <td><input type="number" name="attr_Ddg" value="0"/></td>
                                </tr>
                                <tr>
                                    <th>HP</th>
                                    <th>Str</th>
                                    <th>Mag</th>
                                    <th>Skl</th>
                                    <th>EXP</th>
                                </tr>
                                <tr>
                                    <td><input name="attr_HP_wp" type="number" value="0"></td>
                                    <td><input name="attr_Str_wp" type="number" value="0"></td>
                                    <td><input name="attr_Mag_wp" type="number" value="0"></td>
                                    <td><input name="attr_Skl_wp" type="number" value="0"></td>
                                    <td><input name="attr_wEXP" type="number" value="0"></td>
                                </tr>
                                <tr>
                                    <th>Spd</th>
                                    <th>Lck</th>
                                    <th>Def</th>
                                    <th>Res</th>
                                    <th>Con</th>
                                </tr>
                                <tr>
                                    <td><input name="attr_Spd_wp" type="number" value="0"></td>
                                    <td><input name="attr_Lck_wp" type="number" value="0"></td>
                                    <td><input name="attr_Def_wp" type="number" value="0"></td>
                                    <td><input name="attr_Res_wp" type="number" value="0"></td>
                                    <td><input name="attr_Con_wp" type="number" value="0"></td>
                                </tr>
                            </table>
                            <div class="sheet-hiddenskill">
                                <label style="font-size: 13px; font-weight: bold"> Weapon Description
                                    <input name="attr_Skill_wp" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> Effect
                                    <input name="attr_Eff_wp" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> 1st Effect
                                    <input name="attr_WepEff1" type="text"></input>
                                </label>
                                <label style="font-size: 13px; font-weight: bold"> 2nd Effect
                                    <input name="attr_WepEff2" type="text"></input>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- Misc Page -->
            <div class="sheet-misc">
                <div class="sheet-supportinfo">
                    <div class="sheet-header">Supports</div>
                    <textarea name="attr_supportlist" type="text" style="width:350px; height:500px"></textarea>
                </div>
                <div class="sheet-weapons">
                    <div class="sheet-header">WEAPON RANKS</div>
                    <table>
                        <tr>
                            <th>Weap. Type</th>
                            <th>EXP</th>
                            <th>Rank</th>
                        </tr>
                        <tr>
                            <td>Swords</td>
                            <td><input type="number" value="0" name="attr_SwordEXP" min="0" max="1000"></td>
                            <td><span name="attr_Swordrank"></span></td>
                        </tr>
                        <tr>
                            <td>Lances</td>
                            <td><input type="number" value="0" name="attr_LanceEXP" min="0" max="1000"></td>
                            <td><span name="attr_Lancerank"></span></td>
                        </tr>
                        <tr>
                            <td>Axes</td>
                            <td><input type="number" value="0" name="attr_AxeEXP" min="0" max="1000"></td>
                            <td><span name="attr_Axerank"></span></td>
                        </tr>
                        <tr>
                            <td>Bows</td>
                            <td><input type="number" value="0" name="attr_BowEXP" min="0" max="1000"></td>
                            <td><span name="attr_Bowrank"></span></td>
                        </tr>
                        <tr>
                            <td>Staves</td>
                            <td><input type="number" value="0" name="attr_StavesEXP" min="0" max="1000"></td>
                            <td><span name="attr_Stavesrank"></span></td>
                        </tr>
                        <tr>
                            <td>Anima</td>
                            <td><input type="number" value="0" name="attr_AnimaEXP" min="0" max="1000"></td>
                            <td><span name="attr_Animarank"></span></td>
                        </tr>
                        <tr>
                            <td>Light</td>
                            <td><input type="number" value="0" name="attr_LightEXP" min="0" max="1000"></td>
                            <td><span name="attr_Lightrank"></span></td>
                        </tr>
                        <tr>
                            <td>Dark</td>
                            <td><input type="number" value="0" name="attr_DarkEXP" min="0" max="1000"></td>
                            <td><span name="attr_Darkrank"></span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Equip Page -->
            <div class="sheet-equip">
                <div class="sheet-prowess">
                    <div class="sheet-header">Bonuses</div>
                    <table>
                        <tr>
                            <th>#</th>
                            <th>Check</th>
                            <th>Name</th>
                            <th>HP</th>
                            <th>STR</th>
                            <th>MAG</th>
                            <th>SPD</th>
                            <th>DEF</th>
                            <th>RES</th>
                            <th>CON</th>
                            <th>MOV</th>
                            <th>Hit</th>
                            <th>Avo</th>
                            <th>Crit</th>
                            <th>Ddg</th>
                            <th>Weight</th>
                            <th>Mitigation</th>
                        </tr>
                        <tr>
                            <th>1</th>
                            <td><input type="checkbox" name="attr_bonus_1_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_M" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_M" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_M" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>2</th>
                            <td><input type="checkbox" name="attr_bonus_2_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_S" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_S" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_S" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>3</th>
                            <td><input type="checkbox" name="attr_bonus_3_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_1" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_1" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_1" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>4</th>
                            <td><input type="checkbox" name="attr_bonus_4_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_2" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_2" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_2" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>5</th>
                            <td><input type="checkbox" name="attr_bonus_5_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_3" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_3" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_3" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>6</th>
                            <td><input type="checkbox" name="attr_bonus_6_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_4" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_4" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_4" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>7</th>
                            <td><input type="checkbox" name="attr_bonus_7_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_5" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_5" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_5" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>8</th>
                            <td><input type="checkbox" name="attr_bonus_8_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_6" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_6" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_6" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>9</th>
                            <td><input type="checkbox" name="attr_bonus_9_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_7" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_7" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_7" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>10</th>
                            <td><input type="checkbox" name="attr_bonus_10_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_8" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_8" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_8" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>11</th>
                            <td><input type="checkbox" name="attr_bonus_11_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_9" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_9" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_9" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>12</th>
                            <td><input type="checkbox" name="attr_bonus_12_check" value="1"></td>
                            <td><input type="text" name="attr_Ele_10" style="width: 100%;"></td>
                            <td><input type="number" value="0" name="attr_HP_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Str_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mag_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Spd_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Def_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Res_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Con_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mov_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Hit_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Avo_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Crit_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Ddg_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Weight_10" min="0" max="100"></td>
                            <td><input type="number" value="0" name="attr_Mit_10" min="0" max="100"></td>
                        </tr>
                        <tr>
                            <th>Sum</th>
                            <td>---</td>
                            <td>---</td>
                            <td><span name="attr_HP_Qtotal">0</span></td>
                            <td><span name="attr_Str_Qtotal">0</span></td>
                            <td><span name="attr_Mag_Qtotal">0</span></td>
                            <td><span name="attr_Spd_Qtotal">0</span></td>
                            <td><span name="attr_Def_Qtotal">0</span></td>
                            <td><span name="attr_Res_Qtotal">0</span></td>
                            <td><span name="attr_Con_Qtotal">0</span></td>
                            <td><span name="attr_Mov_Qtotal">0</span></td>
                            <td><span name="attr_Hit_Qtotal">0</span></td>
                            <td><span name="attr_Avo_Qtotal">0</span></td>
                            <td><span name="attr_Crit_Qtotal">0</span></td>
                            <td><span name="attr_Ddg_Qtotal">0</span></td>
                            <td><span name="attr_Weight_Qtotal">0</span></td>
                            <td><span name="attr_Mit_Qtotal">0</span></td>
                        </tr>
                    </table>
                </div>
                <div class="sheet-abilityinfo">
                    <div class="sheet-header">Bonuses</div>
                    <textarea name="attr_Quartzlist" type="text" style="width:350px; height:400px"></textarea>
                </div>
                <div class="sheet-supportinfo">
                    <div class="sheet-header">Equipment</div>
                    <textarea name="attr_equiplist" type="text" style="width:350px; height:400px"></textarea>
                </div>
            </div>

            <script type="text/worker">
                const buttonlist = ["character", "misc", "equip"];
                buttonlist.forEach(button => {
                    on(`clicked:${button}`, function() {
                        setAttrs({sheetTab: button});
                    });
                });

                var getSectionIDsOrdered = function (sectionName, callback) {
                    'use strict';
                    getAttrs([`_reporder_${sectionName}`], function (v) {
                        getSectionIDs(sectionName, function (idArray) {
                            let reporderArray = v[`_reporder_${sectionName}`]? v[`_reporder_${sectionName}`].toLowerCase().split(','): [],
                            ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
                            callback(ids);
                        });
                    });
                };

                // Update HP total depending on atktype and equipped weapon/spell
                function updateHPTotal() {
                    getAttrs(["WSlot","SSlot","atktype","HP_i","HP_bd","HP_Qtotal"], function(vals) {
                        let baseHP = Number(vals.HP_i) + Number(vals.HP_bd) + Number(vals.HP_Qtotal);
                        let atktype = vals.atktype;

                        function setHPFinal(totalHP) {
                            setAttrs({HP_total: totalHP, HP_current_max: totalHP});
                        }

                        if (atktype==="Phys") {
                            getSectionIDsOrdered("repeating_weapons", function(idarray) {
                                let slotnum = vals.WSlot;
                                let fID = idarray[Number(slotnum)-1];
                                if(!fID) {
                                    setHPFinal(baseHP);
                                    return;
                                }
                                getAttrs(["repeating_weapons_"+fID+"_HP_wp"], function(v) {
                                    let wp = parseInt(v["repeating_weapons_"+fID+"_HP_wp"])||0;
                                    setHPFinal(baseHP + wp);
                                });
                            });
                        } else if (atktype==="Mag") {
                            getSectionIDsOrdered("repeating_spells", function(idarray) {
                                let slotnum = vals.SSlot;
                                let fID = idarray[Number(slotnum)-1];
                                if(!fID) {
                                    setHPFinal(baseHP);
                                    return;
                                }
                                getAttrs(["repeating_spells_"+fID+"_HP_wp"], function(v) {
                                    let wp = parseInt(v["repeating_spells_"+fID+"_HP_wp"])||0;
                                    setHPFinal(baseHP + wp);
                                });
                            });
                        } else {
                            setHPFinal(baseHP);
                        }
                    });
                }

                // Update Movement total
                function updateMovTotal() {
                    getAttrs(["Mov_i","Mov_bd","Mov_Qtotal","Mov_multi"], function(v) {
                        let base = Number(v.Mov_i)||0;
                        let bd = Number(v.Mov_bd)||0;
                        let qtotal = Number(v.Mov_Qtotal)||0;
                        let multi = Number(v.Mov_multi)||0;
                        let total = Math.round((base + bd + qtotal)*((100+multi)/100));
                        setAttrs({Mov_total: total});
                    });
                }

                // Helper to get active item modifier for a given stat
                function getActiveItemModifier(stat, callback) {
                    getAttrs(["WSlot","SSlot","atktype"], function(vals) {
                        const type = vals.atktype;
                        let section = null;
                        let slot = null;

                        if (type === "Phys") {
                            section = "weapons";
                            slot = vals.WSlot;
                        } else if (type === "Mag") {
                            section = "spells";
                            slot = vals.SSlot;
                        }

                        if (!section) {
                            callback(0);
                            return;
                        }

                        getSectionIDsOrdered(`repeating_${section}`, function(idarray) {
                            let fID = idarray[Number(slot)-1];
                            if(!fID) {
                                callback(0);
                                return;
                            }

                            let wpAttr = stat+"_wp";
                            getAttrs([`repeating_${section}_${fID}_${wpAttr}`], function(v) {
                                let wp = parseInt(v[`repeating_${section}_${fID}_${wpAttr}`])||0;
                                callback(wp);
                            });
                        });
                    });
                }

                // Helper to get item base stats (Mt, Hit, Crit, Ddg)
                function getActiveItemBaseStats(callback) {
                    getAttrs(["WSlot","SSlot","atktype"], function(vals) {
                        let atktype = vals.atktype;
                        let section = (atktype==="Phys")?"weapons":(atktype==="Mag")?"spells":null;
                        let slot = (atktype==="Phys")?vals.WSlot:(atktype==="Mag")?vals.SSlot:null;
                        if(!section || !slot) {
                            return callback({Mt:0,Hit:0,Crit:0,Ddg:0});
                        }
                        getSectionIDsOrdered(`repeating_${section}`, function(idarray) {
                            let fID = idarray[Number(slot)-1];
                            if(!fID) return callback({Mt:0,Hit:0,Crit:0,Ddg:0});
                            let keys = ["Mt","Hit","Crit","Ddg"].map(k=>`repeating_${section}_${fID}_${k}`);
                            getAttrs(keys, function(v) {
                                let result = {
                                    Mt: parseInt(v[keys[0]])||0,
                                    Hit: parseInt(v[keys[1]])||0,
                                    Crit: parseInt(v[keys[2]])||0,
                                    Ddg: parseInt(v[keys[3]])||0
                                };
                                callback(result);
                            });
                        });
                    });
                }

                // Update total stats after base + buffs + item modifiers
                function updateStatTotal(stat) {
                    let baseAttrs = [stat+"_i", stat+"_bd", stat+"_Qtotal","atktype"];
                    getAttrs(baseAttrs, function(v) {
                        let baseVal = (Number(v[stat+"_i"])||0) + (Number(v[stat+"_bd"])||0) + (Number(v[stat+"_Qtotal"])||0);
                        let atktype = v.atktype;

                        if (atktype !== "Phys" && atktype !== "Mag") {
                            // No item modifiers for neutral atktype
                            let updateObj = {};
                            updateObj[stat+"_total"] = baseVal;
                            setAttrs(updateObj);
                            return;
                        }

                        getActiveItemModifier(stat, function(wp) {
                            let total = baseVal + wp;
                            let updateObj = {};
                            updateObj[stat+"_total"] = total;
                            setAttrs(updateObj);
                        });
                    });
                }

                // Consolidate triggers for all stats into one set of handlers
                const baseStats = ["Str","Mag","Skl","Spd","Lck","Def","Res","Con","Mov"];
                const statChangeTriggers = baseStats.map(s => [
                    `change:${s}_i`,
                    `change:${s}_bd`,
                    `change:${s}_Qtotal`,
                    `change:repeating_weapons:${s}_wp`,
                    `change:repeating_spells:${s}_wp`,
                    `remove:repeating_weapons`,
                    `remove:repeating_spells`
                ]).flat();

                const itemRelatedAttrs = ["WSlot","SSlot","atktype","_reporder:weapons","_reporder:spells"];
                const allStatTriggers = [...statChangeTriggers, ...itemRelatedAttrs.map(i => `change:${i}`)].join(" ");

                on(allStatTriggers, () => {
                    baseStats.forEach(stat => updateStatTotal(stat));
                });

                // C: Unified Growth Calculation
                const growthStats = ["HP","Str","Mag","Skl","Spd","Lck","Def","Res","Con","Mov"];
                growthStats.forEach(stat => {
                    on(`change:${stat}_gf change:${stat}_gi`, () => updateGrowthTotal(stat));
                });

                function updateGrowthTotal(stat) {
                    getAttrs([`${stat}_gf`,`${stat}_gi`], function(v) {
                        const gf = Number(v[`${stat}_gf`])||0;
                        const gi = Number(v[`${stat}_gi`])||0;
                        // Con growth total = gi only, others = gf+gi
                        const total = (stat === "Con") ? gi : gf + gi;
                        let update = {};
                        update[`${stat}_gtotal`] = total;
                        setAttrs(update);
                    });
                }

                // QTotals calculation remains similar, but consolidated trigger is already handled.

                const statsForQTotals = ['HP', 'Str','Mag','Spd','Def','Res','Con','Mov','Hit','Avo','Crit','Ddg','Weight','Mit'];
                const checks = Array.from({length:12}, (_,i)=>`bonus_${i+1}_check`);
                let allStatAttrs = [];
                statsForQTotals.forEach(stat => {
                    allStatAttrs.push(`${stat}_M`, `${stat}_S`);
                    for (let i=1; i<=10; i++){
                        allStatAttrs.push(`${stat}_${i}`);
                    }
                });

                const allTriggersQtotal = checks.map(c=>"change:"+c).concat(allStatAttrs.map(a=>"change:"+a)).join(" ");
                on(allTriggersQtotal, updateAllQTotals);

                function updateAllQTotals() {
                    const allNeededAttrs = checks.concat(allStatAttrs);
                    getAttrs(allNeededAttrs, function(values) {
                        let update = {};
                        statsForQTotals.forEach(stat => {
                            let statModifiers = [
                                values[`${stat}_M`],
                                values[`${stat}_S`]
                            ];
                            for (let i=1; i<=10; i++){
                                statModifiers.push(values[`${stat}_${i}`]);
                            }

                            let sumBonus = 0;
                            statModifiers.forEach((modValue, i) => {
                                let checkValue = values[checks[i]];
                                if(Number(checkValue) === 1) {
                                    sumBonus += Number(modValue)||0;
                                }
                            });

                            update[`${stat}_Qtotal`] = sumBonus;
                        });

                        setAttrs(update);
                    });
                }

                // Centralized Derived Stats Calculation
                // We define a single handler after all relevant changes
                // We'll gather a large set of attributes and compute all derived stats at once.
                const derivedTriggers = [
                    "change:Str_total","change:repeating_weapons:WType","change:Mov_total","change:repeating_weapons:Mt","change:_reporder:weapons","remove:repeating_weapons",
                    "change:Physb","change:WSlot","change:atktype","change:phys_bd",
                    "change:Mag_total","change:repeating_spells:Mt","change:repeating_weapons:SType","change:_reporder:spells","remove:repeating_spells","change:Magb","change:SSlot","change:myst_bd",
                    "change:Def_total","change:Protb","change:prot_bd",
                    "change:Res_total","change:Resb","change:ward_bd",
                    "change:Atkspd","change:Avo_bd","change:Lck_total","change:Avo_Qtotal",
                    "change:Skl_total","change:Hitmod","change:repeating_weapons:Hit","change:repeating_spells:Hit",
                    "change:Hitb","change:Hit_Qtotal","change:hit_bd",
                    "change:Critmod","change:repeating_weapons:Crit","change:repeating_spells:Crit","change:Critb","change:Crit_Qtotal","change:Crit_bd",
                    "change:Ddg_bd","change:Ddg_Qtotal","change:repeating_weapons:Ddg","change:repeating_spells:Ddg"
                ].join(" ");

                on(derivedTriggers, updateDerivedStats);

                function updateDerivedStats() {
                    const needed = [
                        "atktype","WSlot","SSlot","Str_total","Mag_total","Def_total","Res_total","Skl_total","Lck_total","Atkspd",
                        "Protb","prot_bd","Resb","ward_bd","Avo_bd","Avo_Qtotal","Hitb","Hitmod","Hit_Qtotal","hit_bd",
                        "Critb","Critmod","Crit_Qtotal","Crit_bd","Ddg_bd","Ddg_Qtotal","phys_bd","Physb","myst_bd","Magb"
                    ];
                    getAttrs(needed, function(v) {
                        getActiveItemBaseStats(function(itemStats) {
                            const update = calculateAllDerivedStats(v, itemStats);
                            setAttrs(update);
                        });
                    });
                }

                function calculateAllDerivedStats(v, itemStats) {
                    let atktype = v.atktype;
                    let Str = Number(v.Str_total)||0;
                    let Mag = Number(v.Mag_total)||0;
                    let Def = Number(v.Def_total)||0;
                    let Res = Number(v.Res_total)||0;
                    let Skl = Number(v.Skl_total)||0;
                    let Lck = Number(v.Lck_total)||0;
                    let spd = Number(v.Atkspd)||0;

                    let Protb = Number(v.Protb)||0;
                    let prot_bd = Number(v.prot_bd)||0;
                    let Resb = Number(v.Resb)||0;
                    let ward_bd = Number(v.ward_bd)||0;
                    let Avo_bd = Number(v.Avo_bd)||0;
                    let AvoQ = Number(v.Avo_Qtotal)||0;
                    let Hitb = Number(v.Hitb)||0;
                    let Hitmod = Number(v.Hitmod)||0;
                    let HitQ = Number(v.Hit_Qtotal)||0;
                    let hit_bd = Number(v.hit_bd)||0;
                    let Critb = Number(v.Critb)||0;
                    let Critmod = Number(v.Critmod)||0;
                    let CritQ = Number(v.Crit_Qtotal)||0;
                    let Crit_bd = Number(v.Crit_bd)||0;
                    let Ddg_bd = Number(v.Ddg_bd)||0;
                    let DdgQ = Number(v.Ddg_Qtotal)||0;
                    let phys_bd = Number(v.phys_bd)||0;
                    let Physb = Number(v.Physb)||0;
                    let myst_bd = Number(v.myst_bd)||0;
                    let Magb = Number(v.Magb)||0;

                    let prot_total = Def + Protb + prot_bd;
                    let ward_total = Res + Resb + ward_bd;
                    let avo = spd*2 + Math.floor(Lck/2) + Avo_bd + AvoQ;

                    let wMt = itemStats.Mt;
                    let wHit = itemStats.Hit;
                    let wCrit = itemStats.Crit;
                    let wDdg = itemStats.Ddg;

                    let phys_total = 0, myst_total = 0, Hit = 0, Crit = 0, Ddg = 0, effdmg = 0;

                    if(atktype==="Phys"){
                        phys_total = Str + wMt + Physb + phys_bd;
                        effdmg = Str + 3*wMt + Physb + phys_bd;
                        Hit = wHit + hit_bd + Hitb + Hitmod + Skl*2 + Math.floor(Lck/2) + HitQ;
                        Crit = Math.round((Skl/2)+(Lck/2)+CritQ + wCrit + Crit_bd);
                        Ddg = 100 + Lck + DdgQ + wDdg + Ddg_bd;
                    } else if(atktype==="Mag"){
                        myst_total = Mag + wMt + Magb + myst_bd;
                        effdmg = Mag + 3*wMt + Magb + myst_bd;
                        Hit = wHit + hit_bd + Hitb + Hitmod + Skl*2 + Math.floor(Lck/2) + HitQ;
                        Crit = Math.round((Skl/2)+(Lck/2)+wCrit+Critb+Critmod+CritQ+Crit_bd);
                        Ddg = 100 + Lck + DdgQ + wDdg + Ddg_bd;
                    } else {
                        // Neutral atktype
                    }

                    return {
                        phys_total,
                        myst_total,
                        prot_total,
                        ward_total,
                        avo,
                        Hit,
                        Crit,
                        Ddg,
                        effdmg
                    };
                }

                // Update weapon and spell lists
                on('change:repeating_weapons remove:repeating_weapons change:atktype change:WSlot', () => {
                    getSectionIDsOrdered('repeating_weapons', (idarray) => {
                        let keys = idarray.map((id)=>"repeating_weapons_"+id+"_WName");
                        getAttrs(keys, (values) => {
                            let list = idarray.map((id) => values["repeating_weapons_"+id+"_WName"]);
                            setAttrs({weplist: list});
                        });
                    });
                });

                on('change:repeating_spells remove:repeating_spells change:atktype change:SSlot', () => {
                    getSectionIDsOrdered('repeating_spells', (idarray) => {
                        let keys = idarray.map((id)=>"repeating_spells_"+id+"_SName");
                        getAttrs(keys, (values) => {
                            let list = idarray.map((id) => values["repeating_spells_"+id+"_SName"]);
                            setAttrs({splist: list});
                        });
                    });
                });

                on("change:repeating_weapons:WName change:repeating_spells:SName change:repeating_weapons:Eff_wp change:repeating_spells:Eff_wp change:repeating_weapons:WepEff1 change:repeating_weapons:WepEff2 change:repeating_spells:WepEff1 change:repeating_spells:WepEff2 change:repeating_weapons:Skill_wp change:repeating_spells:Skill_wp change:atktype change:_reporder:weapons change:_reporder:spells remove:repeating_spells remove:repeating_weapons change:WSlot change:SSlot", function() {
                    getAttrs(["WSlot","SSlot","atktype"], function(vals) {
                        let atktype = vals.atktype;
                        let section = atktype==="Phys"?"weapons":atktype==="Mag"?"spells":null;
                        let slot = atktype==="Phys"?vals.WSlot:(atktype==="Mag"?vals.SSlot:null);
                        if(!section || !slot)return;
                        getSectionIDsOrdered(`repeating_${section}`, function(idarray) {
                            let fID = idarray[Number(slot)-1];
                            if(!fID)return;
                            let prefix = `repeating_${section}_${fID}_`;
                            let keys = [prefix+"Skill_wp",prefix+"Eff_wp",prefix+(section==="weapons"?"WName":"SName"),prefix+"WepEff1",prefix+"WepEff2"];
                            getAttrs(keys, function(v) {
                                let wepdesc = v[prefix+"Skill_wp"];
                                let effdesc = v[prefix+"Eff_wp"];
                                let namedesc = v[prefix+(section==="weapons"?"WName":"SName")];
                                setAttrs({currDesc: wepdesc, currEff: effdesc, currName: namedesc});
                            });
                        });
                    });
                });

                // Single Weapon Rank Handler
                const weaponTypes = ["Sword","Lance","Axe","Bow","Staves","Dark","Anima","Light"];
                weaponTypes.forEach(type => {
                    on(`change:${type}EXP`, () => updateWeaponRank(type));
                });

                function updateWeaponRank(type) {
                    getAttrs([`${type}EXP`], v => {
                        let currEXP = Number(v[`${type}EXP`])||0;
                        let [rank, exp] = setRank(currEXP);
                        let update = {};
                        update[`${type}EXP`] = exp;
                        // For displayed rank attribute, using lowercase for the attribute name as per original code:
                        update[`${type.toLowerCase()}rank`] = rank;
                        setAttrs(update);
                    });
                }

                function setRank(currEXP) {
                    let Rank = "E";
                    let r = currEXP;
                    if (currEXP <= 30) Rank = "E";
                    else if (currEXP <= 70) Rank = "D";
                    else if (currEXP <=120) Rank = "C";
                    else if (currEXP <=180) Rank = "B";
                    else if (currEXP <=254) Rank = "A";
                    else {
                        Rank = "S";
                        r = 255;
                    }
                    return [Rank, r];
                }

                // Handle uses going to zero for weapons/spells
                on("change:repeating_weapons:uses", function() {
                    getAttrs(["repeating_weapons_WName","repeating_weapons_uses"], function(v){
                        let usev = parseInt(v["repeating_weapons_uses"])||0;
                        if(usev===0){
                            setAttrs({"repeating_weapons_WName":"Broken "+v["repeating_weapons_WName"]});
                        }
                    });
                });
                on("change:repeating_spells:uses", function() {
                    getAttrs(["repeating_spells_SName","repeating_spells_uses"], function(v){
                        let usev = parseInt(v["repeating_spells_uses"])||0;
                        if(usev===0){
                            setAttrs({"repeating_spells_SName":"Broken "+v["repeating_spells_SName"]});
                        }
                    });
                });

                // Initial triggers on sheet open
                on("sheet:opened", function() {
                    updateHPTotal();
                    updateMovTotal();
                    baseStats.forEach(stat => updateStatTotal(stat));
                    updateDerivedStats();
                    updateAllQTotals();
                    growthStats.forEach(updateGrowthTotal);
                    weaponTypes.forEach(updateWeaponRank);
                });

                // Additional triggers for HP/Mov changes
                on("change:HP_i change:HP_bd change:HP_Qtotal change:WSlot change:SSlot change:atktype remove:repeating_weapons remove:repeating_spells change:repeating_weapons:HP_wp change:repeating_spells:HP_wp change:_reporder:weapons change:_reporder:spells", updateHPTotal);
                on("change:Mov_i change:Mov_bd change:Mov_Qtotal change:Mov_multi", updateMovTotal);

            </script>
        </div>
    </div>
</div>

<!-- Hidden Fields (unchanged) -->
<div class="hidden">
    <input name="attr_wepnum" value="0" hidden>
    <input name="attr_spellnum" value="0" hidden>
    <input name="attr_currEff" value=" " hidden>
    <input name="attr_currName" value=" " hidden>
    <input name="attr_currMt" value="0" hidden>
    <input name="attr_currHit" value="0" hidden>
    <input name="attr_currCrit" value="0" hidden>
    <input name="attr_currDdg" value="0" hidden>
    <input name="attr_effdmg" value="0" hidden>
    <input name="attr_currDesc" value="Attacking @{target|token_name}!" hidden>
    <input name="attr_atktype" value="Phys" hidden>
    <input name="attr_SwordHit" value="0" hidden>
    <input name="attr_Skl_Qtotal" value="0" hidden>
    <input name="attr_Spd_Qtotal" value="0" hidden>
    <input name="attr_Lck_Qtotal" value="0" hidden>
    <input name="attr_Def_Qtotal" value="0" hidden>
    <input name="attr_Res_Qtotal" value="0" hidden>
    <input name="attr_Mov_Qtotal" value="0" hidden>
    <input name="attr_Hit_Qtotal" value="0" hidden>
    <input name="attr_Avo_Qtotal" value="0" hidden>
    <input name="attr_Weight_Qtotal" value="0" hidden>
    <input name="attr_HP_total_max" value="0" hidden>
    <input name="attr_HP_current" value="0" hidden>
    <input name="attr_HP_current_max" value="0" hidden>
    <input type="number" name="attr_HP_Qtotal" value="0" hidden>
    <input name="attr_Con_current" value="0" hidden>
    <input name="attr_Con_current_max" value="0" hidden>
    <input name="attr_Str_total" value="0" hidden>
    <input name="attr_Str_gf" value="0" hidden>
    <input name="attr_Str_gtotal" value="0" hidden>
    <input name="attr_Str_total_max" value="0" hidden>
    <input name="attr_Mag_total" value="0" hidden>
    <input name="attr_Mag_gf" value="0" hidden>
    <input name="attr_Mag_gtotal" value="0" hidden>
    <input name="attr_Mag_total_max" value="0" hidden>
    <input name="attr_Skl_total" value="0" hidden>
    <input name="attr_Skl_gf" value="0" hidden>
    <input name="attr_Skl_gtotal" value="0" hidden>
    <input name="attr_Skl_total_max" value="0" hidden>
    <input name="attr_Spd_total" value="0" hidden>
    <input name="attr_Spd_gf" value="0" hidden>
    <input name="attr_Spd_gtotal" value="0" hidden>
    <input name="attr_Spd_total_max" value="0" hidden>
    <input name="attr_Lck_total" value="0" hidden>
    <input name="attr_Lck_gf" value="0" hidden>
    <input name="attr_Lck_gtotal" value="0" hidden>
    <input name="attr_Lck_total_max" value="0" hidden>
    <input name="attr_Def_total" value="0" hidden>
    <input name="attr_Def_gf" value="0" hidden>
    <input name="attr_Def_gtotal" value="0" hidden>
    <input name="attr_Def_total_max" value="0" hidden>
    <input name="attr_Res_total" value="0" hidden>
    <input name="attr_Res_gf" value="0" hidden>
    <input name="attr_Res_gtotal" value="0" hidden>
    <input name="attr_Res_total_max" value="0" hidden>
    <input name="attr_Mov_gf" value="0" hidden>
    <input name="attr_Mov_gtotal" value="0" hidden>
    <input name="attr_Mov_total_max" value="0" hidden>
    <input name="attr_Mov_total" value="0" hidden>
    <input name="attr_Str_multi" value="0" hidden>
    <input name="attr_Mag_multi" value="0" hidden>
    <input name="attr_Spd_multi" value="0" hidden>
    <input name="attr_Skl_multi" value="0" hidden>
    <input name="attr_Def_multi" value="0" hidden>
    <input name="attr_Res_multi" value="0" hidden>
    <input name="attr_Mov_multi" value="0" hidden>
    <input name="attr_DR_multi" value="0" hidden>
    <input name="attr_EXP" value="0" min="0" max="200" hidden>
    <input name="attr_Swordrank" value="E" type="text" hidden>
    <input name="attr_Lancerank" value="E" type="text" hidden>
    <input name="attr_Axerank" value="E" type="text" hidden>
    <input name="attr_Bowrank" value="E" type="text" hidden>
    <input name="attr_Stavesrank" value="E" type="text" hidden>
    <input name="attr_Darkrank" value="E" type="text" hidden>
    <input name="attr_Lightrank" value="E" type="text" hidden>
    <input name="attr_Animarank" value="E" type="text" hidden>
    <input name="attr_Hit" value="0" hidden>
    <input name="attr_Crit" value="0" hidden>
    <input name="attr_avo" value="0" hidden>
    <input name="attr_phys_total" value="0" hidden>
    <input name="attr_myst_total" value="0" hidden>
    <input name="attr_prot_total" value="0" hidden>
    <input name="attr_ward_total" value="0" hidden>
    <input name="attr_Atkspd" value="0" min="0" hidden>
    <input name="attr_Dmgmod" value="0" hidden>
    <input name="attr_UACounter" value="0" type="checkbox" hidden>
    <input name="attr_Physb" value="0" hidden>
    <input name="attr_Magb" value="0" hidden>
    <input name="attr_Hitb" value="0" hidden>
    <input name="attr_Critb" value="0" hidden>
    <input name="attr_Critavob" value="0" hidden>
    <input name="attr_Avob" value="0" hidden>
    <input name="attr_Protb" value="0" hidden>
    <input name="attr_Resb" value="0" hidden>
</div>
</html>
